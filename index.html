<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shinobi Proposal Arc</title>
    <style>
        /* --- CSS STYLES (Colors & Animations) --- */
        :root {
            --purple: #6e00ff;
            --red: #ff003c;
            --pink: #ff7eb9;
            --dark: #050505;
        }

        body { 
            margin: 0; 
            background: radial-gradient(circle, #1a0033 0%, #000 100%); /* Force Dark Background */
            color: white; 
            font-family: 'Courier New', monospace; 
            overflow: hidden; 
            user-select: none; 
            touch-action: manipulation;
        }

        .screen { 
            display: none; /* Hidden by default */
            width: 100%; 
            height: 100vh; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            position: absolute; 
            top: 0; 
            left: 0; 
        }

        .screen.active { display: flex; } /* Only the active screen shows */

        /* INTRO SEAL GAME */
        .cinematic-text { 
            font-size: 2rem; 
            text-shadow: 0 0 15px var(--purple); 
            margin-bottom: 10px;
        }
        
        #seal-container { display: flex; gap: 20px; margin: 30px; }
        
        .seal-lock {
            width: 70px; height: 70px; 
            border: 3px solid var(--purple); 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; color: white;
            cursor: pointer; 
            animation: pulse 1.5s infinite; 
            background: rgba(110, 0, 255, 0.1);
            transition: 0.3s;
        }
        
        .seal-lock:active { transform: scale(0.9); background: var(--purple); }

        /* MAP GRID */
        .map-header { border: 1px solid white; padding: 5px 20px; margin-bottom: 20px; font-size: 0.8rem; letter-spacing: 2px; }
        .map-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 90%; max-width: 350px; }
        .grid-item { 
            border: 2px solid var(--pink); 
            background: rgba(255, 126, 185, 0.1); 
            padding: 15px; 
            cursor: pointer; 
            transition: 0.3s; 
            display: flex; flex-direction: column; align-items: center;
        }
        .grid-item.locked { filter: grayscale(1); opacity: 0.3; pointer-events: none; border-color: #555; }
        .grid-item span { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .grid-label { font-size: 0.7rem; color: var(--pink); font-weight: bold; text-transform: uppercase; }

        /* GAME AREA */
        #game-area { 
            width: 300px; height: 350px; 
            border: 2px solid var(--purple); 
            margin-bottom: 10px; 
            position: relative; 
            overflow: hidden; 
            background: rgba(255,255,255,0.05); 
        }
        canvas { width: 100%; height: 100%; }

        /* MEMORY CARDS */
        .memory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; height: 100%; box-sizing: border-box; }
        .card { background: var(--purple); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .card.flipped { background: white; color: black; }
        .card.matched { background: var(--red); opacity: 0; pointer-events: none; transition: 0.5s; }

        /* FINAL SCREEN */
        .scroll-reveal { 
            width: 85%; padding: 25px; 
            border: 2px solid var(--purple); 
            background: rgba(0,0,0,0.95); 
            box-shadow: 0 0 25px var(--purple); 
            z-index: 10; 
            animation: fadeUp 2s ease-out; 
        }
        .anime-paragraph { font-size: 0.9rem; line-height: 1.5; color: #ddd; text-align: justify; margin: 15px 0; font-style: italic; }
        .sakura-storm { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; 
            background: url('https://www.transparenttextures.com/patterns/dust.png'); 
            opacity: 0.4; 
            animation: snow 10s linear infinite; 
        }

        /* UI ELEMENTS */
        #power-bar { width: 80%; height: 8px; border: 1px solid var(--purple); margin: 10px auto; border-radius: 4px; }
        #power-fill { height: 100%; width: 0%; background: var(--red); transition: width 0.1s; }
        .shinobi-btn { background: black; color: white; border: 1px solid var(--purple); padding: 10px 20px; margin: 5px; cursor: pointer; letter-spacing: 2px; font-weight: bold; }
        .inventory-bar { margin-top: 20px; font-size: 1.2rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 5px var(--purple); } 50% { box-shadow: 0 0 20px var(--purple); } 100% { box-shadow: 0 0 5px var(--purple); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes snow { from { background-position: 0 0; } to { background-position: 100px 500px; } }
    </style>
</head>
<body>
    
    <div id="intro-screen" class="screen active">
        <h1 class="cinematic-text">SHINOBI ARCHIVE</h1>
        <p>SECURITY SEAL ACTIVE</p>
        <div id="seal-container">
            <div class="seal-lock" onclick="hitSeal(this)">Â∞Å</div>
            <div class="seal-lock" onclick="hitSeal(this)">Âç∞</div>
            <div class="seal-lock" onclick="hitSeal(this)">Ëß£</div>
        </div>
        <p style="font-size: 0.8rem; opacity: 0.7;">Tap the 3 Seals to Break the Barrier</p>
    </div>

    <div id="map-screen" class="screen">
        <div class="map-header">MISSION SELECT</div>
        <div class="map-grid" id="mapGrid"></div>
        <div class="inventory-bar">
            SCROLLS: <span id="scroll-count">0</span>/6 üìú
        </div>
    </div>

    <div id="game-container" class="screen">
        <h2 id="game-title" style="margin-bottom: 5px;"></h2>
        <div id="game-area"></div>
        <div id="ui">
            <p id="game-instruction" style="font-size: 0.9rem; color: #aaa;"></p>
            <div id="power-bar"><div id="power-fill"></div></div>
        </div>
        <button class="shinobi-btn" onclick="enterMap()">RETREAT</button>
    </div>

    <div id="final-screen" class="screen">
        <div class="sakura-storm"></div>
        <div class="scroll-reveal">
            <h1 style="color: #ff003c; text-shadow: 0 0 10px #ff003c;">MISSION COMPLETE</h1>
            <p class="anime-paragraph">
                By the power of the Six Paths and the strength of your ninja way, you have cleared every trial. 
                Your chakra is pure, and your resolve is unbreakable. In this world of shinobi, a connection 
                like ours is rarer than a Forbidden Jutsu. You have conquered the darkness; now, let us walk 
                towards the light together.
            </p>
            <h2 style="margin-top: 20px;">Will you be my Player 2?</h2>
            <div style="margin-top: 20px;">
                <button id="yesBtn" class="shinobi-btn" onclick="celebrate()">YES</button>
                <button id="noBtn" class="shinobi-btn">NO</button>
            </div>
        </div>
    </div>

    <audio id="bgm" loop></audio>

    <script>
        /* --- JAVASCRIPT LOGIC --- */
        let scrolls = 0;
        let sealsBroken = 0;
        let animationFrame;
        let gameActive = false;
        const missions = [
            { id: 1, name: "Chakra Charge", icon: "‚ö°", type: "tap", instr: "Tap screen fast to charge!", unlocked: true },
            { id: 2, name: "Sharingan Memory", icon: "üëÅÔ∏è", type: "memory", instr: "Match the pairs!", unlocked: false },
            { id: 3, name: "Kunai Deflect", icon: "üó°Ô∏è", type: "timing", instr: "Tap when the bar hits GREEN!", unlocked: false },
            { id: 4, name: "Shadow Clone", icon: "üë•", type: "whack", instr: "Tap the REAL Naruto (ü¶ä)!", unlocked: false },
            { id: 5, name: "Golibaje Guard", icon: "ü•ü", type: "defense", instr: "Tap enemies before they eat!", unlocked: false },
            { id: 6, name: "Demon Duel", icon: "üëπ", type: "boss", instr: "Mash to overpower Kurama!", unlocked: false }
        ];

        // --- INTRO GAME: SEAL BREAKER ---
        function hitSeal(el) {
            el.style.transform = "scale(1.5)";
            el.style.opacity = "0";
            el.style.pointerEvents = "none";
            sealsBroken++;
            if(sealsBroken >= 3) {
                setTimeout(() => {
                    document.getElementById('intro-screen').classList.remove('active');
                    document.getElementById('map-screen').classList.add('active');
                    renderMap();
                }, 500);
            }
        }

        // --- MAP SYSTEM ---
        function renderMap() {
            const grid = document.getElementById('mapGrid');
            grid.innerHTML = '';
            missions.forEach(m => {
                const div = document.createElement('div');
                div.className = `grid-item ${m.unlocked ? '' : 'locked'}`;
                div.innerHTML = `<span>${m.icon}</span><div class="grid-label">${m.name}</div>`;
                if(m.unlocked) div.onclick = () => launchGame(m);
                grid.appendChild(div);
            });
            document.getElementById('scroll-count').innerText = scrolls;
        }

        function enterMap() {
            gameActive = false;
            cancelAnimationFrame(animationFrame);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('map-screen').classList.add('active');
            renderMap();
        }

        // --- GAME LAUNCHER ---
        function launchGame(m) {
            document.getElementById('map-screen').classList.remove('active');
            document.getElementById('game-container').classList.add('active');
            document.getElementById('game-title').innerText = m.name;
            document.getElementById('game-instruction').innerText = m.instr;
            document.getElementById('power-fill').style.width = "0%";
            const area = document.getElementById('game-area');
            area.innerHTML = ''; 
            gameActive = true;

            if(m.type === 'memory') startMemoryGame(area);
            else {
                const canvas = document.createElement('canvas');
                canvas.width = 300; canvas.height = 350;
                area.appendChild(canvas);
                const ctx = canvas.getContext('2d');
                
                if(m.type === 'tap' || m.type === 'boss') startTapGame(canvas, ctx);
                if(m.type === 'timing') startTimingGame(canvas, ctx);
                if(m.type === 'whack') startWhackGame(canvas, ctx);
                if(m.type === 'defense') startDefenseGame(canvas, ctx);
            }
        }

        // --- MINI GAMES ---

        // 1. Memory Game
        function startMemoryGame(area) {
            const icons = ['üç•','üç•','ü¶ä','ü¶ä','üó°Ô∏è','üó°Ô∏è','üë∫','üë∫','‚ö°','‚ö°','üìú','üìú'];
            let deck = icons.sort(() => 0.5 - Math.random());
            let flipped = [], matched = 0;
            
            const grid = document.createElement('div');
            grid.className = 'memory-grid';
            
            deck.forEach((icon) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.val = icon;
                card.onclick = () => {
                    if(flipped.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                        card.innerText = icon;
                        card.classList.add('flipped');
                        flipped.push(card);
                        if(flipped.length === 2) setTimeout(checkMatch, 600);
                    }
                };
                grid.appendChild(card);
            });
            area.appendChild(grid);

            function checkMatch() {
                const [c1, c2] = flipped;
                if(c1.dataset.val === c2.dataset.val) {
                    c1.classList.add('matched'); c2.classList.add('matched');
                    matched += 2; 
                    document.getElementById('power-
